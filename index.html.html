<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SUPENSIÓN IA</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; display: flex; height: 100vh; }
    #sidebar { width: 250px; background-color: #1a1a1a; color: white; padding: 20px; overflow-y: auto; }
    #main { flex-grow: 1; padding: 20px; overflow-y: auto; }
    button { width: 100%; padding: 10px; margin-bottom: 10px; background-color: #333; color: white; border: none; cursor: pointer; border-radius: 5px; text-align: left; }
    button:hover { background-color: #555; }
    .tag { display: inline-block; background-color: #ddd; padding: 2px 5px; margin: 2px; border-radius: 3px; font-size: 12px; }
    .prompt-preview { background-color: #f9f9f9; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px; }
    .hidden { display: none; }
    .editable { background-color: #ffffcc; border-bottom: 1px dashed #ccc; cursor: text; }
    .search-input { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; }
    #login-container { margin: auto; text-align: center; padding: 20px; }
    #login-container input { padding: 10px; margin-bottom: 10px; width: 200px; }
    #login-container button { padding: 10px 20px; }
  </style>
</head>
<body>
  <div id="login-container" class="hidden">
    <h2>Acceso a SUPENSIÓN IA</h2>
    <input type="text" id="reference" placeholder="Ingrese su referencia" />
    <br />
    <button onclick="validateAccess()">Acceder</button>
    <p id="login-error" style="color: red;"></p>
  </div>

  <div id="sidebar" class="hidden">
    <button onclick="showAllPrompts()">Inicio</button>
    <div id="category-buttons"></div>
    <button id="user-access" class="hidden">Acceso a Usuarios</button>
    <button id="prompts-access" class="hidden">Prompts</button>
    <button onclick="logout()">Cerrar sesión</button>
  </div>

  <div id="main" class="hidden">
    <input type="text" class="search-input" placeholder="Buscar..." oninput="searchPrompts(event)" />
    <div id="subcategory-buttons"></div>
    <div id="prompts"></div>
  </div>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSd5yoasP3pxVzZvV-XwaurTOhxNl00JtMRh0bLYnp-SEmg3L-Q1wXH9Q7u-fLZqjJaoY6wmmrD1Y4K/pub?output=csv";
    let promptsData = [], currentCategory = "", currentSubcategory = "", currentUserState = "";

    window.onload = () => {
      const storedAccess = localStorage.getItem("accessReference");
      if (storedAccess) validateAccess(storedAccess, true);
      else document.getElementById("login-container").classList.remove("hidden");
    };

    function validateAccess(ref = null, auto = false) {
      const inputRef = ref || document.getElementById("reference").value.trim();
      fetch(CSV_URL)
        .then(res => res.text())
        .then(csv => {
          const rows = csv.trim().split("\n").slice(1).map(line => line.split(","));
          const user = rows.find(r => r[1] === inputRef);
          if (!user) return showError("Referencia no válida.");
          const expiry = new Date(user[2]);
          const today = new Date();
          if (today > expiry) return showError("Acceso vencido.");
          currentUserState = user[3];
          localStorage.setItem("accessReference", inputRef);
          initializeApp();
        })
        .catch(() => showError("Error al verificar el acceso."));

      function showError(msg) {
        if (!auto) document.getElementById("login-error").textContent = msg;
      }
    }

    function initializeApp() {
      document.getElementById("login-container").classList.add("hidden");
      document.getElementById("sidebar").classList.remove("hidden");
      document.getElementById("main").classList.remove("hidden");
      if (currentUserState.includes("M")) {
        document.getElementById("user-access").classList.remove("hidden");
        document.getElementById("prompts-access").classList.remove("hidden");
      }
      loadPrompts();
    }

    function logout() {
      if (confirm("¿Está seguro que desea cerrar sesión?")) {
        localStorage.removeItem("accessReference");
        location.reload();
      }
    }

    function loadPrompts() {
      const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRtZ8NUWB0rJmTVJ9rsVqYgZQq0q4xqOe0P51gB1OkL3JYJvLOeN3Wy1rrRwlQhuV0Ad20K7Y3x1Zcs/pub?output=csv";
      fetch(url)
        .then(res => res.text())
        .then(csv => {
          const rows = csv.trim().split("\n").map(line => line.split(","));
          const headers = rows.shift();
          promptsData = rows.map(r => Object.fromEntries(headers.map((h, i) => [h, r[i]])));
          displayCategories();
          showAllPrompts();
        });
    }

    function displayCategories() {
      const categories = [...new Set(promptsData.map(p => p.Categoría))];
      const container = document.getElementById("category-buttons");
      container.innerHTML = "";
      categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.onclick = () => filterByCategory(cat);
        container.appendChild(btn);
      });
    }

    function filterByCategory(category) {
      currentCategory = category;
      currentSubcategory = "";
      const subcategories = [...new Set(promptsData.filter(p => p.Categoría === category).map(p => p.Subcategoría))];
      const container = document.getElementById("subcategory-buttons");
      container.innerHTML = "";
      subcategories.forEach(sub => {
        const btn = document.createElement("button");
        btn.textContent = sub;
        btn.onclick = () => filterBySubcategory(sub);
        container.appendChild(btn);
      });
      displayPrompts(promptsData.filter(p => p.Categoría === category));
    }

    function filterBySubcategory(subcategory) {
      currentSubcategory = subcategory;
      const filtered = promptsData.filter(p => p.Categoría === currentCategory && p.Subcategoría === subcategory);
      displayPrompts(filtered);
    }

    function showAllPrompts() {
      currentCategory = "";
      currentSubcategory = "";
      document.getElementById("subcategory-buttons").innerHTML = "";
      displayPrompts(promptsData);
    }

    function displayPrompts(prompts) {
      const container = document.getElementById("prompts");
      container.innerHTML = "";
      prompts.forEach(p => {
        const div = document.createElement("div");
        div.className = "prompt-preview";
        const tags = p.Etiquetas ? p.Etiquetas.split(",").map(tag => `<span class="tag">${tag.trim()}</span>`).join("") : "";
        const promptText = p.Prompt.replace(/\[(.*?)\]/g, (_, text) => `<span contenteditable="true" class="editable">${text}</span>`);
        div.innerHTML = `<strong>${p.Título}</strong><br><div>${promptText}</div><br>${tags}<br><button onclick="copyPrompt(this)">Copiar</button>`;
        container.appendChild(div);
      });
    }

    function copyPrompt(btn) {
      const text = btn.parentElement.querySelector("div").innerText;
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = "Copiado!";
        setTimeout(() => btn.textContent = "Copiar", 1500);
      });
    }

    function searchPrompts(event) {
      const term = event.target.value.toLowerCase();
      const filtered = promptsData.filter(p =>
        p.Título.toLowerCase().includes(term) ||
        p.Categoría.toLowerCase().includes(term) ||
        p.Subcategoría.toLowerCase().includes(term) ||
        p.Etiquetas.toLowerCase().includes(term) ||
        p.Prompt.toLowerCase().includes(term)
      );
      displayPrompts(filtered);
    }
  </script>
</body>
</html>
